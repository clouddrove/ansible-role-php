---
# install php


- name: add php 7 repo
  apt_repository:
    repo: 'ppa:ondrej/php'
    update_cache: true
    validate_certs: false

- name: add php 7 repo
  apt_repository:
    repo: 'ppa:ondrej/php'
    update_cache: true
    validate_certs: false

- name: install php-fpm and packages
  apt:
    name: [
      'php7.2-fpm',
      'php7.2',
      'php7.2-common',
      'php7.2-cli',
      'php7.2-curl',
      'php7.2-gd',
      'php7.2-gmp',
      'php7.2-imap',
      'php7.2-intl',
      'php7.2-readline',
      'php7.2-opcache',
      'php7.2-mysql',
      'php7.2-json',
      'php7.2-apcu',
      'php-redis',
      'php7.2-apcu',
      'php7.2-bz2',
      'php7.2-bcmath',
      'php7.2-mbstring',
      'php7.2-soap',
      'php7.2-xml',
      'php7.2-zip',
      'php7.2-dev',
      'php7.2-mongodb',
      'php7.2-sqlite3',
      'pkg-config',
      'libssl-dev',
      'libsslcommon2-dev',
      'libpcre3-dev',
      'libsasl2-dev'
    ]
    state: present
    update_cache: true
    cache_valid_time: 5400
  register: phpfpm_result
  notify:
    - reload php-fpm

- name: ensure phpfpm log is enabled
  file:
    path: /var/log/php/
    mode: 0755
    state: directory

- name: ensure phpfpm log is enabled
  changed_when: false
  file:
    path: "{{ item }}"
    mode: 0644
    state: touch
  with_items:
    - /var/log/php-pool-upstream.error.log
    - /var/log/php-pool-queue.error.log
    - /var/log/php-ini-error.log
    - /var/log/php-pool-www.error.log

- name: download composer
  get_url:
    url: http://getcomposer.org/installer
    force: true
    dest: /tmp/composer
    mode: 0755

- name: install composer
  command: php /tmp/composer --install-dir=/usr/local/bin creates=/usr/local/bin/composer  # yamllint disable-line rule:line-length

- name: rename composer.phar to composer
  command: mv /usr/local/bin/composer.phar /usr/local/bin/composer creates=/usr/local/bin/composer  # yamllint disable-line rule:line-length

- name: make composer executable
  file:
    path: /usr/local/bin/composer
    mode: a+x
    state: file

- name: make composer executable
  file:
    path: /usr/local/bin/composer
    mode: a+x
    state: file
